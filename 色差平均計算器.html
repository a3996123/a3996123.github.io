<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lab 四組平均計算器</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1320;--accent:#6ee7b7;--muted:#94a3b8;--glass: rgba(255,255,255,0.04)}
    *{box-sizing:border-box;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Helvetica Neue', Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(135deg,#071029 0%,#09203f 50%,#081521 100%);color:#e6eef6;display:flex;align-items:center;justify-content:center;padding:32px}
    .wrap{width:100%;max-width:980px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04)}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    .group{background:var(--glass);padding:12px;border-radius:10px}
    .group h3{margin:0 0 8px 0;font-size:13px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=number]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;font-size:14px}
    .actions{display:flex;gap:10px;align-items:center;margin-top:14px}
    button{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#042018;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
    .result{display:flex;gap:14px;align-items:center;margin-top:16px}
    .result .box{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;min-width:120px}
    .swatch{width:84px;height:84px;border-radius:8px;border:1px solid rgba(0,0,0,0.25);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    .footer{margin-top:12px;color:var(--muted);font-size:12px}
    @media (max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}header{flex-direction:column;align-items:flex-start} .result{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Lab 四組平均計算器</h1>
        <p class="lead">輸入 4 組 L, a, b 值 → 立即計算平均值並預覽平均顏色</p>
      </div>
    </header>

    <div class="card">
      <form id="labForm" onsubmit="event.preventDefault();calcAvg();">
        <div class="grid">
          <div class="group">
            <h3>樣本 1</h3>
            <label>L</label>
            <input type="number" step="0.01" name="L1" value="50.00">
            <label>a</label>
            <input type="number" step="0.01" name="a1" value="0.00">
            <label>b</label>
            <input type="number" step="0.01" name="b1" value="0.00">
          </div>

          <div class="group">
            <h3>樣本 2</h3>
            <label>L</label>
            <input type="number" step="0.01" name="L2" value="50.00">
            <label>a</label>
            <input type="number" step="0.01" name="a2" value="0.00">
            <label>b</label>
            <input type="number" step="0.01" name="b2" value="0.00">
          </div>

          <div class="group">
            <h3>樣本 3</h3>
            <label>L</label>
            <input type="number" step="0.01" name="L3" value="50.00">
            <label>a</label>
            <input type="number" step="0.01" name="a3" value="0.00">
            <label>b</label>
            <input type="number" step="0.01" name="b3" value="0.00">
          </div>

          <div class="group">
            <h3>樣本 4</h3>
            <label>L</label>
            <input type="number" step="0.01" name="L4" value="50.00">
            <label>a</label>
            <input type="number" step="0.01" name="a4" value="0.00">
            <label>b</label>
            <input type="number" step="0.01" name="b4" value="0.00">
          </div>
        </div>

        <div class="actions">
          <button type="button" onclick="calcAvg()">計算平均</button>
          <button type="button" class="ghost" onclick="resetForm()">重置</button>
          <button type="button" class="ghost" onclick="exportCSV()">匯出 CSV</button>
        </div>

        <div class="result" id="resultArea" style="display:none">
          <div class="box">
            <div style="font-size:12px;color:var(--muted)">平均值</div>
            <div id="avgL" style="font-size:18px;font-weight:700">L: -</div>
            <div id="avga" style="font-size:18px;font-weight:700">a: -</div>
            <div id="avgb" style="font-size:18px;font-weight:700">b: -</div>
          </div>

          <div class="box">
            <div style="font-size:12px;color:var(--muted)">色差參考 (ΔE) - 快速參考</div>
            <div id="deltaText" style="font-size:14px;font-weight:600">—</div>
          </div>

          <div class="box" style="display:flex;flex-direction:column;align-items:center;justify-content:center">
            <div style="font-size:12px;color:var(--muted);margin-bottom:8px">平均顏色預覽</div>
            <div class="swatch" id="swatch"></div>
          </div>
        </div>

        <div class="footer">提示：欄位支援小數（步進 0.01）。若需更多樣本或匯出格式請告訴我。</div>
      </form>
    </div>
  </div>

  <script>
    // Utility: Lab -> XYZ -> sRGB
    function labToXyz(L, a, b){
      // Observer= 2°, Illuminant= D65
      var y = (L + 16) / 116;
      var x = a / 500 + y;
      var z = y - b / 200;

      function pivot(t){
        var t3 = t*t*t;
        return t3 > 0.008856 ? t3 : (t - 16/116)/7.787;
      }
      x = pivot(x) * 95.047;
      y = pivot(y) * 100.000;
      z = pivot(z) * 108.883;
      return {x:x,y:y,z:z};
    }

    function xyzToRgb(x,y,z){
      // X Y Z are in [0..100]
      x/=100; y/=100; z/=100;
      var r = x *  3.2406 + y * -1.5372 + z * -0.4986;
      var g = x * -0.9689 + y *  1.8758 + z *  0.0415;
      var b = x *  0.0557 + y * -0.2040 + z *  1.0570;
      function comp(c){
        return c<=0.0031308 ? 12.92*c : 1.055*Math.pow(c,1/2.4)-0.055;
      }
      r = comp(r); g = comp(g); b = comp(b);
      // clamp
      r = Math.min(Math.max(0, r), 1);
      g = Math.min(Math.max(0, g), 1);
      b = Math.min(Math.max(0, b), 1);
      return {r:Math.round(r*255), g:Math.round(g*255), b:Math.round(b*255)};
    }

    function labToRgb(L,a,b){
      var xyz = labToXyz(L,a,b);
      return xyzToRgb(xyz.x, xyz.y, xyz.z);
    }

    function calcAvg(){
      var form = document.getElementById('labForm');
      var vals=[];
      for(var i=1;i<=4;i++){
        var L = parseFloat(form['L'+i].value)||0;
        var A = parseFloat(form['a'+i].value)||0;
        var B = parseFloat(form['b'+i].value)||0;
        vals.push({L:L,a:A,b:B});
      }
      var sumL=0,sumA=0,sumB=0;
      vals.forEach(v=>{sumL+=v.L;sumA+=v.a;sumB+=v.b});
      var avgL = sumL/vals.length;
      var avga = sumA/vals.length;
      var avgb = sumB/vals.length;

      document.getElementById('avgL').textContent = 'L: ' + avgL.toFixed(2);
      document.getElementById('avga').textContent = 'a: ' + avga.toFixed(2);
      document.getElementById('avgb').textContent = 'b: ' + avgb.toFixed(2);
      document.getElementById('resultArea').style.display = 'flex';

      // Color preview
      var rgb = labToRgb(avgL,avga,avgb);
      var hex = '#' + [rgb.r,rgb.g,rgb.b].map(x=>x.toString(16).padStart(2,'0')).join('');
      var sw = document.getElementById('swatch');
      sw.style.background = hex;

      // Simple deltaE between sample1 and average as quick reference (CIE76)
      var s1 = vals[0];
      var dE = Math.sqrt(Math.pow(s1.L-avgL,2)+Math.pow(s1.a-avga,2)+Math.pow(s1.b-avgb,2));
      document.getElementById('deltaText').textContent = 'Sample1 vs Avg ΔE (CIE76): ' + dE.toFixed(2);

      return {avg:{L:avgL,a:avga,b:avgb},samples:vals,hex:hex};
    }

    function resetForm(){
      var form = document.getElementById('labForm');
      for(var i=1;i<=4;i++){
        form['L'+i].value = '50.00';
        form['a'+i].value = '0.00';
        form['b'+i].value = '0.00';
      }
      document.getElementById('resultArea').style.display='none';
    }

    function exportCSV(){
      var data = calcAvg();
      var rows = [];
      rows.push(['sample','L','a','b']);
      data.samples.forEach((s,i)=>rows.push(['S'+(i+1),s.L,s.a,s.b]));
      rows.push([]);
      rows.push(['avg', data.avg.L.toFixed(2), data.avg.a.toFixed(2), data.avg.b.toFixed(2)]);
      rows.push(['hex', data.hex, '', '']);
      var csv = rows.map(r=>r.join(',')).join('\n');
      var blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url; a.download = 'lab_samples_avg.csv';
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // Recalculate live when inputs change
    document.querySelectorAll('input[type=number]').forEach(inp=>inp.addEventListener('input', ()=>{
      try{calcAvg();}catch(e){}
    }));

    // initial calc
    calcAvg();
  </script>
</body>
</html>