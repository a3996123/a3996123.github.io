<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Lab 五組平均計算器</title>
  <style>
    /* 1. Global Styles */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        min-height: 100vh;
        box-sizing: border-box;
        color: #333;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* 2. Glass Container */
    .container {
        width: 100%;
        max-width: 980px; /* Specific width for this layout */
        margin: auto;
        background: rgba(255, 255, 255, 0.25);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 16px;
        padding: 30px;
        box-sizing: border-box;
    }

    /* 3. Headers */
    header { display: flex; align-items: center; gap: 16px; margin-bottom: 18px; }
    h1, h2, h3 { color: #333; font-weight: 600; margin-top: 0; }
    h1 { font-size: 1.8em; margin: 0; }
    h3 { font-size: 1.1em; margin-bottom: 10px; color: #222; }
    p.lead { margin: 0; color: #444; font-size: 1em; }

    /* 4. Form Element Styling */
    label { display: block; margin-bottom: 6px; font-weight: 500; color: #555; }
    input[type="number"] {
        width: 100%; padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px; font-size: 1em; box-sizing: border-box; color: #333;
        transition: all 0.2s ease;
    }
    input[type="number"]:focus {
        outline: none; border-color: rgba(0, 86, 179, 0.5);
        background: #fff; box-shadow: 0 0 8px rgba(31, 38, 135, 0.1);
    }
    input[type=number] { -moz-appearance: textfield; }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

    button {
        padding: 12px 18px; font-size: 1.1em; font-weight: 600;
        color: #fff; background-color: #0056b3;
        border: none; border-radius: 8px; cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    button:hover { background-color: #004494; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    button.ghost {
        background: rgba(255, 255, 255, 0.4); color: #333;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    button.ghost:hover { background: rgba(255, 255, 255, 0.7); }

    /* 5. Layout & Result Styles */
    .grid {
        display: grid;
        /* Changed grid layout for 5 items */
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 14px;
        margin-bottom: 20px;
    }
    .group {
        background: rgba(255, 255, 255, 0.15);
        padding: 15px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .actions { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
    .result { display: flex; gap: 14px; margin-top: 25px; flex-wrap: wrap; }
    .result .box {
        background: rgba(255, 255, 255, 0.3);
        padding: 15px;
        border-radius: 10px;
        flex-grow: 1; min-width: 150px;
    }
    .swatch {
        width: 84px; height: 84px; border-radius: 8px;
        border: 1px solid rgba(0,0,0,0.1);
        margin: 0 auto;
    }
    .footer { margin-top: 20px; color: #555; font-size: 0.9em; text-align: center; }

    /* 6. Responsive */
    @media (max-width: 900px) {
        .grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 720px){
        body { padding: 10px; align-items: flex-start; }
        .container { padding: 20px; }
        header{ flex-direction:column; align-items:flex-start; } 
        .result{ flex-direction:column; align-items:stretch; }
    }
    @media (max-width: 500px) {
        .grid { grid-template-columns: 1fr; }
        .actions { flex-direction: column; }
        button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Lab 五組平均計算器</h1>
        <p class="lead">輸入 L, a, b 值 → 立即計算平均值並預覽平均顏色</p>
      </div>
    </header>

    <form id="labForm" onsubmit="event.preventDefault();calcAvg();">
      <div class="grid">
        <div class="group">
          <h3>樣本 1</h3>
          <label>L</label>
          <input type="number" step="0.01" name="L1">
          <label>a</label>
          <input type="number" step="0.01" name="a1">
          <label>b</label>
          <input type="number" step="0.01" name="b1">
        </div>

        <div class="group">
          <h3>樣本 2</h3>
          <label>L</label>
          <input type="number" step="0.01" name="L2">
          <label>a</label>
          <input type="number" step="0.01" name="a2">
          <label>b</label>
          <input type="number" step="0.01" name="b2">
        </div>

        <div class="group">
          <h3>樣本 3</h3>
          <label>L</label>
          <input type="number" step="0.01" name="L3">
          <label>a</label>
          <input type="number" step="0.01" name="a3">
          <label>b</label>
          <input type="number" step="0.01" name="b3">
        </div>

        <div class="group">
          <h3>樣本 4</h3>
          <label>L</label>
          <input type="number" step="0.01" name="L4">
          <label>a</label>
          <input type="number" step="0.01" name="a4">
          <label>b</label>
          <input type="number" step="0.01" name="b4">
        </div>
        
        <div class="group">
          <h3>樣本 5</h3>
          <label>L</label>
          <input type="number" step="0.01" name="L5">
          <label>a</label>
          <input type="number" step="0.01" name="a5">
          <label>b</label>
          <input type="number" step="0.01" name="b5">
        </div>
      </div>

      <div class="actions">
        <button type="button" onclick="calcAvg()">計算平均</button>
        <button type="button" class="ghost" onclick="resetForm()">重置</button>
        <button type="button" class="ghost" onclick="exportCSV()">匯出 CSV</button>
      </div>

      <div class="result" id="resultArea" style="display:none">
        <div class="box">
          <div style="font-size:12px;color:var(--muted)">平均值</div>
          <div id="avgL" style="font-size:18px;font-weight:700">L: -</div>
          <div id="avga" style="font-size:18px;font-weight:700">a: -</div>
          <div id="avgb" style="font-size:18px;font-weight:700">b: -</div>
        </div>

        <div class="box">
          <div style="font-size:12px;color:var(--muted)">色差參考 (ΔE) - 快速參考</div>
          <div id="deltaText" style="font-size:14px;font-weight:600">—</div>
        </div>

        <div class="box" style="display:flex;flex-direction:column;align-items:center;justify-content:center">
          <div style="font-size:12px;color:var(--muted);margin-bottom:8px">平均顏色預覽</div>
          <div class="swatch" id="swatch"></div>
        </div>
      </div>

      <div class="footer">提示：欄位支援小數（步進 0.01）。若需更多樣本或匯出格式請告訴我。</div>
    </form>
  </div>

  <script>
    // Utility: Lab -> XYZ -> sRGB
    function labToXyz(L, a, b){
      // Observer= 2°, Illuminant= D65
      var y = (L + 16) / 116;
      var x = a / 500 + y;
      var z = y - b / 200;

      function pivot(t){
        var t3 = t*t*t;
        return t3 > 0.008856 ? t3 : (t - 16/116)/7.787;
      }
      x = pivot(x) * 95.047;
      y = pivot(y) * 100.000;
      z = pivot(z) * 108.883;
      return {x:x,y:y,z:z};
    }

    function xyzToRgb(x,y,z){
      // X Y Z are in [0..100]
      x/=100; y/=100; z/=100;
      var r = x * 3.2406 + y * -1.5372 + z * -0.4986;
      var g = x * -0.9689 + y * 1.8758 + z * 0.0415;
      var b = x * 0.0557 + y * -0.2040 + z * 1.0570;
      function comp(c){
        return c<=0.0031308 ? 12.92*c : 1.055*Math.pow(c,1/2.4)-0.055;
      }
      r = comp(r); g = comp(g); b = comp(b);
      // clamp
      r = Math.min(Math.max(0, r), 1);
      g = Math.min(Math.max(0, g), 1);
      b = Math.min(Math.max(0, b), 1);
      return {r:Math.round(r*255), g:Math.round(g*255), b:Math.round(b*255)};
    }

    function labToRgb(L,a,b){
      var xyz = labToXyz(L,a,b);
      return xyzToRgb(xyz.x, xyz.y, xyz.z);
    }

    // === JS 修改：calcAvg() ===
    function calcAvg(){
      var form = document.getElementById('labForm');
      var vals=[]; // 只儲存有效的樣本
      var sumL=0,sumA=0,sumB=0;

      // 迴圈 5 組
      for(var i=1;i<=5;i++){
        var L_val = form['L'+i].value;
        var a_val = form['a'+i].value;
        var b_val = form['b'+i].value;

        // 檢查該組是否有任何輸入
        if(L_val !== '' || a_val !== '' || b_val !== '') {
            var L = parseFloat(L_val)||0; // 對組內的空值使用 0
            var A = parseFloat(a_val)||0;
            var B = parseFloat(b_val)||0;
            vals.push({L:L,a:A,b:B}); // 將有效組加入陣列
            sumL += L;
            sumA += A;
            sumB += B;
        }
      }
      
      var numValidSamples = vals.length; // 取得有效組的數量
      document.getElementById('resultArea').style.display = 'flex'; // 保持顯示結果區域

      if (numValidSamples === 0) {
        // 如果沒有任何有效輸入，顯示空狀態
        document.getElementById('avgL').textContent = 'L: -';
        document.getElementById('avga').textContent = 'a: -';
        document.getElementById('avgb').textContent = 'b: -';
        document.getElementById('deltaText').textContent = '—';
        document.getElementById('swatch').style.background = 'transparent';
        return {avg:{L:0,a:0,b:0},samples:[],hex:'#transparent'}; // 為了 exportCSV
      }

      var avgL = sumL / numValidSamples;
      var avga = sumA / numValidSamples;
      var avgb = sumB / numValidSamples;

      document.getElementById('avgL').textContent = 'L: ' + avgL.toFixed(2);
      document.getElementById('avga').textContent = 'a: ' + avga.toFixed(2);
      document.getElementById('avgb').textContent = 'b: ' + avgb.toFixed(2);

      // Color preview
      var rgb = labToRgb(avgL,avga,avgb);
      var hex = '#' + [rgb.r,rgb.g,rgb.b].map(x=>x.toString(16).padStart(2,'0')).join('');
      var sw = document.getElementById('swatch');
      sw.style.background = hex;

      // Simple deltaE between sample1 and average as quick reference (CIE76)
      // 只有在 vals[0] (即樣本1) 存在時才計算
      if (vals.length > 0 && (form['L1'].value !== '' || form['a1'].value !== '' || form['b1'].value !== '')) {
        var s1 = vals.find((v,i) => (form['L'+(i+1)].name === 'L1')); // 
        if (s1) {
            var dE = Math.sqrt(Math.pow(s1.L-avgL,2)+Math.pow(s1.a-avga,2)+Math.pow(s1.b-avgb,2));
            document.getElementById('deltaText').textContent = 'Sample1 vs Avg ΔE (CIE76): ' + dE.toFixed(2);
        } else {
             document.getElementById('deltaText').textContent = '—';
        }
      } else {
        document.getElementById('deltaText').textContent = '—';
      }

      return {avg:{L:avgL,a:avga,b:avgb},samples:vals,hex:hex};
    }

    // === JS 修改：resetForm() ===
    function resetForm(){
      var form = document.getElementById('labForm');
      for(var i=1;i<=5;i++){ // 迴圈 5 組
        form['L'+i].value = ''; // 設為空值
        form['a'+i].value = ''; // 設為空值
        form['b'+i].value = ''; // 設為空值
      }
      calcAvg(); // 重置後重新計算 (會顯示空狀態)
    }

    function exportCSV(){
      var data = calcAvg(); // calcAvg() 已被修改, data.samples 只包含有效組
      var rows = [];
      rows.push(['sample','L','a','b']);
      // 這裡的 data.samples 已經是過濾後的有效組
      data.samples.forEach((s,i)=>rows.push(['S_Valid_'+(i+1), s.L, s.a, s.b])); 
      rows.push([]);
      if(data.samples.length > 0) {
        rows.push(['avg', data.avg.L.toFixed(2), data.avg.a.toFixed(2), data.avg.b.toFixed(2)]);
        rows.push(['hex', data.hex, '', '']);
      } else {
        rows.push(['avg', '-', '-', '-']);
      }
      var csv = rows.map(r=>r.join(',')).join('\n');
      var blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url; a.download = 'lab_samples_avg.csv';
      document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // Recalculate live when inputs change
    document.querySelectorAll('input[type=number]').forEach(inp=>inp.addEventListener('input', ()=>{
      try{calcAvg();}catch(e){}
    }));

    // initial calc (現在會顯示空狀態)
    calcAvg();
  </script>
</body>
</html>
