<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Excel 資料轉換器（多分頁＋額外頁）</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Excel 多分頁轉換器</h2>
  <p>功能：上傳 Excel → 建立「全部 + 各桶別 + 額外分頁」→ 下載</p>
  <input type="file" id="upload" accept=".xlsx,.xls" />
  <button onclick="processExcel()">轉換並下載</button>

  <script>
    let workbook;

    document.getElementById('upload').addEventListener('change', (e) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        const data = new Uint8Array(event.target.result);
        workbook = XLSX.read(data, { type: 'array' });
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    function processExcel() {
      if (!workbook) {
        alert("請先上傳 Excel 檔案！");
        return;
      }

      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, {
        header: 1,
        defval: "",
        blankrows: false
      });

      const header = ["桶別", "B", "C", "D", "E", "F", "G"];
      const allData = [header];
      const groupSheets = {};

      // 👇 額外分頁用：N, A, H後段
      const extraSheetHeader = ["N欄", "A欄", "H欄後段"];
      const extraSheetData = [extraSheetHeader];

      let currentGroup = "";
      let currentDValue = "";
      let currentNValue = ""; // ⬅️ for N欄向下填滿
      let currentAValue = ""; // ⬅️ for A欄向下填滿（在額外分頁 B 欄）

      for (let i = 1; i < json.length; i++) {
        const row = json[i];

        const colA = row[0];    // A欄（桶別）
        const colE = row[4];    // E欄 → G
        const colG = row[6];    // G欄 → D
        const colH = row[7];    // H欄
        const colI = row[8];    // I欄 → C
        const colK = row[10];   // K欄 → F
        const colN = row[13];   // N欄 → 額外分頁 A 欄

        if (colA && colA.trim() !== "") {
          currentGroup = colA;
          currentAValue = colA;
        }

        if (colG && colG.toString().trim() !== "") {
          currentDValue = colG;
        }

        if (colN && colN.toString().trim() !== "") {
          currentNValue = colN;
        }

        // 拆解 H 欄
        let beforeDash = "", afterDash = "";
        if (typeof colH === "string" && colH.includes("-")) {
          const parts = colH.split("-");
          beforeDash = parts[0];
          afterDash = parts[1];
        }

        // ✅ 主資料表與桶別分頁
        const newRow = [
          currentGroup,     // A
          afterDash,        // B
          colI,             // C
          currentDValue,    // D
          beforeDash,       // E
          colK,             // F
          colE              // G
        ];
        allData.push(newRow);

        if (!groupSheets[currentGroup]) {
          groupSheets[currentGroup] = [header.slice()];
        }
        groupSheets[currentGroup].push(newRow);

        // ✅ 額外分頁資料
        extraSheetData.push([
          currentNValue,     // A: N欄（向下填滿）
          currentAValue,     // B: A欄（向下填滿）
          afterDash          // C: H欄後段
        ]);
      }

      const newWorkbook = XLSX.utils.book_new();

      // 加入全部資料分頁
      const allSheet = XLSX.utils.aoa_to_sheet(allData);
      XLSX.utils.book_append_sheet(newWorkbook, allSheet, "全部");

      // 加入每個桶別的分頁
      for (const groupName in groupSheets) {
        const sheetData = groupSheets[groupName];
        const safeSheetName = groupName.length > 31 ? groupName.slice(0, 31) : groupName;
        const sheet = XLSX.utils.aoa_to_sheet(sheetData);
        XLSX.utils.book_append_sheet(newWorkbook, sheet, safeSheetName);
      }

      // ✅ 加入額外分頁
      const extraSheet = XLSX.utils.aoa_to_sheet(extraSheetData);
      XLSX.utils.book_append_sheet(newWorkbook, extraSheet, "N_A_H後段");

      XLSX.writeFile(newWorkbook, "轉換後資料_含分類與額外頁.xlsx");
    }
  </script>
</body>
</html>
