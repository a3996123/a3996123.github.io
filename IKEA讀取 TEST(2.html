<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Excel è³‡æ–™è½‰æ›å™¨ï¼ˆå¤šåˆ†é ï¼‹é¡å¤–é ï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Excel å¤šåˆ†é è½‰æ›å™¨</h2>
  <p>åŠŸèƒ½ï¼šä¸Šå‚³ Excel â†’ å»ºç«‹ã€Œå…¨éƒ¨ + å„æ¡¶åˆ¥ + é¡å¤–åˆ†é ã€â†’ ä¸‹è¼‰</p>
  <input type="file" id="upload" accept=".xlsx,.xls" />
  <button onclick="processExcel()">è½‰æ›ä¸¦ä¸‹è¼‰</button>

  <script>
    let workbook;

    document.getElementById('upload').addEventListener('change', (e) => {
      const reader = new FileReader();
      reader.onload = (event) => {
        const data = new Uint8Array(event.target.result);
        workbook = XLSX.read(data, { type: 'array' });
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    function processExcel() {
      if (!workbook) {
        alert("è«‹å…ˆä¸Šå‚³ Excel æª”æ¡ˆï¼");
        return;
      }

      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, {
        header: 1,
        defval: "",
        blankrows: false
      });

      const header = ["æ¡¶åˆ¥", "B", "C", "D", "E", "F", "G"];
      const allData = [header];
      const groupSheets = {};

      // ğŸ‘‡ é¡å¤–åˆ†é ç”¨ï¼šN, A, Hå¾Œæ®µ
      const extraSheetHeader = ["Næ¬„", "Aæ¬„", "Hæ¬„å¾Œæ®µ"];
      const extraSheetData = [extraSheetHeader];

      let currentGroup = "";
      let currentDValue = "";
      let currentNValue = ""; // â¬…ï¸ for Næ¬„å‘ä¸‹å¡«æ»¿
      let currentAValue = ""; // â¬…ï¸ for Aæ¬„å‘ä¸‹å¡«æ»¿ï¼ˆåœ¨é¡å¤–åˆ†é  B æ¬„ï¼‰

      for (let i = 1; i < json.length; i++) {
        const row = json[i];

        const colA = row[0];    // Aæ¬„ï¼ˆæ¡¶åˆ¥ï¼‰
        const colE = row[4];    // Eæ¬„ â†’ G
        const colG = row[6];    // Gæ¬„ â†’ D
        const colH = row[7];    // Hæ¬„
        const colI = row[8];    // Iæ¬„ â†’ C
        const colK = row[10];   // Kæ¬„ â†’ F
        const colN = row[13];   // Næ¬„ â†’ é¡å¤–åˆ†é  A æ¬„

        if (colA && colA.trim() !== "") {
          currentGroup = colA;
          currentAValue = colA;
        }

        if (colG && colG.toString().trim() !== "") {
          currentDValue = colG;
        }

        if (colN && colN.toString().trim() !== "") {
          currentNValue = colN;
        }

        // æ‹†è§£ H æ¬„
        let beforeDash = "", afterDash = "";
        if (typeof colH === "string" && colH.includes("-")) {
          const parts = colH.split("-");
          beforeDash = parts[0];
          afterDash = parts[1];
        }

        // âœ… ä¸»è³‡æ–™è¡¨èˆ‡æ¡¶åˆ¥åˆ†é 
        const newRow = [
          currentGroup,     // A
          afterDash,        // B
          colI,             // C
          currentDValue,    // D
          beforeDash,       // E
          colK,             // F
          colE              // G
        ];
        allData.push(newRow);

        if (!groupSheets[currentGroup]) {
          groupSheets[currentGroup] = [header.slice()];
        }
        groupSheets[currentGroup].push(newRow);

        // âœ… é¡å¤–åˆ†é è³‡æ–™
        extraSheetData.push([
          currentNValue,     // A: Næ¬„ï¼ˆå‘ä¸‹å¡«æ»¿ï¼‰
          currentAValue,     // B: Aæ¬„ï¼ˆå‘ä¸‹å¡«æ»¿ï¼‰
          afterDash          // C: Hæ¬„å¾Œæ®µ
        ]);
      }

      const newWorkbook = XLSX.utils.book_new();

      // åŠ å…¥å…¨éƒ¨è³‡æ–™åˆ†é 
      const allSheet = XLSX.utils.aoa_to_sheet(allData);
      XLSX.utils.book_append_sheet(newWorkbook, allSheet, "å…¨éƒ¨");

      // åŠ å…¥æ¯å€‹æ¡¶åˆ¥çš„åˆ†é 
      for (const groupName in groupSheets) {
        const sheetData = groupSheets[groupName];
        const safeSheetName = groupName.length > 31 ? groupName.slice(0, 31) : groupName;
        const sheet = XLSX.utils.aoa_to_sheet(sheetData);
        XLSX.utils.book_append_sheet(newWorkbook, sheet, safeSheetName);
      }

      // âœ… åŠ å…¥é¡å¤–åˆ†é 
      const extraSheet = XLSX.utils.aoa_to_sheet(extraSheetData);
      XLSX.utils.book_append_sheet(newWorkbook, extraSheet, "N_A_Hå¾Œæ®µ");

      XLSX.writeFile(newWorkbook, "è½‰æ›å¾Œè³‡æ–™_å«åˆ†é¡èˆ‡é¡å¤–é .xlsx");
    }
  </script>
</body>
</html>
