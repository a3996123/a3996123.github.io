<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>外幣 ↔ 台幣（1 TWD 可換多少外幣）</title>
  <style>
    :root{
      --bg:#0b0b0b; --wrap:#111; --card:#161616; --ink:#f5f7fa; --muted:#9aa4b2;
      --brand:#10b981; --brand-2:#64748b; --border:#2a2a2a; --input:#0e0e0e;
      --radius:16px; --shadow:0 12px 32px rgba(0,0,0,.28);
      --gap: clamp(12px, 2.6vw, 24px);
      --fs-base: clamp(18px, 2.4vw + .4rem, 28px);
      --fs-lg: clamp(22px, 3.4vw + .6rem, 44px);
      --fs-sm: clamp(14px, 1.2vw + .25rem, 18px);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: Arial,"Noto Sans TC","Microsoft JhengHei",system-ui,sans-serif;
      background:var(--bg); color:var(--ink); min-height:100vh;
      display:flex; align-items:flex-start; justify-content:center; padding:16px; font-size:var(--fs-base);
    }
    .wrap{
      width:min(1040px,100%); background:var(--wrap); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:calc(var(--gap)*1.0); display:flex; flex-direction:column;
    }
    h1{ margin:0 0 .4em 0; text-align:center; font-size:var(--fs-lg) }
    .sub{ text-align:center; color:var(--muted); font-size:var(--fs-sm); margin-bottom:var(--gap) }

    /* 置中主要面板 */
    .panel{ width:min(840px,100%); margin:0 auto; }

    /* 匯率列：縮小、置中 */
    .rate-row{
      display:flex; align-items:center; justify-content:center; gap:.7em; flex-wrap:wrap;
      margin-bottom: calc(var(--gap) * .8);
    }
    .rate-row .rate-info{
      padding:.45em .8em; border:1.5px solid #1f8a6f; border-radius:12px;
      min-width:11ch; text-align:center; font-weight:700;
    }
    .rate-row select, .rate-row input[type="text"]{
      height:2.2em; padding:.35em .6em; font-size:var(--fs-sm);
      border:2px solid var(--border); border-radius:10px; outline:none;
      background:var(--input); color:var(--ink);
    }
    .rate-row .mini-btn{
      height:2.2em; padding:0 .8em; font-size:var(--fs-sm);
      border:none; border-radius:10px; cursor:pointer;
    }
    .mini-btn.use{ background:var(--brand); color:#000 }
    .mini-btn.gray{ background:#374151; color:#fff }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:var(--gap) }
    label{ display:block; color:var(--muted); font-size:var(--fs-sm); margin-bottom:.35em; text-align:center }
    input[type="text"]{
      width:100%; padding:.9em 1em; font-size:var(--fs-base);
      border:2px solid var(--border); border-radius:12px; outline:none; background:var(--input); color:var(--ink);
      transition:border-color .15s; text-align:center;
    }
    input[type="text"]:focus{ border-color:#2dd4bf }

    .hint{ color:var(--muted); font-size:var(--fs-sm); text-align:center; margin-top:.4em }

    .sum{ text-align:center; margin:.8em 0; font-weight:700; letter-spacing:.5px }
    .sum b{ color:#a7f3d0 }

    .result{ margin-top:.8em; text-align:center; font-weight:800; font-size: clamp(36px, 5vw, 64px); color:#e7f8ef }
    .btn-row{ display:flex; gap:.6em; align-items:center; margin-top: var(--gap); flex-wrap:wrap; justify-content:center }
    .btn{ flex:1; padding:.8em 1em; font-size:var(--fs-base); border:none; border-radius:12px; cursor:pointer; color:#000; background:var(--brand); text-align:center }
    .btn.secondary{ background: var(--brand-2); color:#fff }
    @media (min-width:600px){ .btn{ flex:unset; min-width:120px } }

    .hide{ display:none !important; }
  </style>
</head>
<body>
<main class="wrap">
  <h1>外幣 ↔ 台幣</h1>
  <div class="sub">顯示為「1 TWD 可換多少外幣」。預設線上匯率；手動輸入後會被記錄，除非改回線上或再次手動。</div>

  <!-- 匯率與幣別（縮小、置中） -->
  <div class="panel">
    <div class="rate-row">
      <label for="ccy" class="hide">幣別</label>
      <select id="ccy" aria-label="選擇幣別">
        <option value="KRW">韓元 KRW</option>
        <option value="JPY">日圓 JPY</option>
        <option value="CNY">人民幣 CNY</option>
        <option value="USD">美金 USD</option>
        <option value="EUR">歐元 EUR</option>
      </select>

      <span class="rate-info" id="rateInfo">1 TWD = 0.000000 CCY</span>

      <input id="rateInput" type="text" inputmode="decimal" placeholder="手動：1 TWD 可換多少外幣" />
      <button class="mini-btn use" id="applyRate">套用</button>
      <button class="mini-btn gray" id="restoreOnline">線上</button>
    </div>

    <!-- 輸入面板 -->
    <section class="card" aria-label="換算">
      <label id="label-in">輸入外幣（KRW）或運算式</label>
      <input id="inVal" type="text" inputmode="decimal" placeholder="例如：10000 或 12+3*4/2" />

      <div class="sum" id="sumBox">合計：<b>–</b></div>

      <!-- 小輸出框保留但隱藏（不佔版位、JS 可繼續使用） -->
      <label id="label-out" class="hide">換算台幣 (TWD)</label>
      <input id="outVal" class="hide" type="text" placeholder="自動計算" readonly />

      <div class="result" id="convResult">TWD 0</div>
      <div class="hint">輸入時先顯示「合計」，再依匯率換算。</div>
    </section>

    <div class="btn-row">
      <button class="btn" id="refresh">更新匯率</button>
      <button class="btn" id="swap">↔ 互換方向</button>
      <button class="btn secondary" id="clearConv">清除</button>
    </div>
  </div>
</main>

<script>
  // ============= 基本狀態與工具 =============
  // rateFT = 外幣/台幣（每 1 TWD 可換多少外幣）
  const DEFAULT_RATES_FT = { KRW: 40, JPY: 4, CNY: 0.22, USD: 0.031, EUR: 0.029 };
  const FX_KEY = 'fx_rates_v3_ccy_per_twd';
  const ONE_DAY = 24*60*60*1000;

  const state = { ccy:'KRW', rateFT:DEFAULT_RATES_FT.KRW, direction:'FOREIGN_TO_TWD' };

  // DOM
  const elCcy = document.getElementById('ccy');
  const elRateInfo = document.getElementById('rateInfo');
  const elIn = document.getElementById('inVal');
  const elOut = document.getElementById('outVal');
  const elRes = document.getElementById('convResult');
  const elSwap = document.getElementById('swap');
  const elClr = document.getElementById('clearConv');
  const elRefresh = document.getElementById('refresh');
  const labelIn = document.getElementById('label-in');
  const rateInput = document.getElementById('rateInput');
  const applyRate = document.getElementById('applyRate');
  const restoreOnline = document.getElementById('restoreOnline');
  const sumBox = document.getElementById('sumBox');

  const nfTWD = new Intl.NumberFormat('zh-Hant-TW',{style:'currency',currency:'TWD',maximumFractionDigits:4});
  const nfInt = new Intl.NumberFormat('zh-Hant-TW');
  const nfRate = new Intl.NumberFormat('zh-Hant-TW',{maximumFractionDigits:6});

  function loadCache(){ try{return JSON.parse(localStorage.getItem(FX_KEY)||'{}');}catch{return{};} }
  function saveCache(c){ localStorage.setItem(FX_KEY,JSON.stringify(c)); }
  function getItem(ccy){ const c=loadCache(); return c[ccy]||{}; }
  function setItem(ccy, obj){ const c=loadCache(); c[ccy]=obj; saveCache(c); }

  // 線上拿 TWD/外幣 的倒數 -> 外幣/台幣
  async function fetchRateFT(ccy){
    const url=`https://open.er-api.com/v6/latest/${encodeURIComponent(ccy)}`;
    const res=await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error('Network');
    const json=await res.json();
    const twdPerCcy = json?.rates?.TWD;
    if(typeof twdPerCcy !== 'number') throw new Error('Bad');
    const ft = 1 / twdPerCcy;
    const ts = (json.time_last_update_unix||0)*1000;
    return { rateFT: ft, ts };
  }

  // 表示與格式
  function renderRate(){ elRateInfo.textContent = `1 TWD = ${nfRate.format(state.rateFT)} ${state.ccy}`; }
  function formatInt(n){ return nfInt.format(Math.trunc(n)); }

  // 允許的運算式，安全計算
  function safeEvalExpr(raw){
    const s = (raw||'').replace(/[,\s]/g,'');
    if(!s) return NaN;
    for(const ch of s){
      if(!((ch>='0'&&ch<='9')||'+-*/.()'.includes(ch))) return NaN;
    }
    try{
      const val = Function('"use strict";return('+s+')')();
      return (typeof val==='number' && Number.isFinite(val)) ? val : NaN;
    }catch{ return NaN; }
  }

  // 主渲染：先顯示合計，再換算
  function render(){
    const subtotal = safeEvalExpr(elIn.value);
    if(Number.isNaN(subtotal)){
      sumBox.innerHTML = '合計：<b>–</b>';
      elRes.textContent = (state.direction==='FOREIGN_TO_TWD' ? 'TWD 0' : `${state.ccy} 0`);
      elOut.value = '';
      return;
    }
    // 合計顯示（整數化）
    sumBox.innerHTML = '合計：<b>' + formatInt(subtotal) + '</b>';

    if(state.direction==='FOREIGN_TO_TWD'){
      // 外幣 -> 台幣：1 外幣 = 1/rateFT TWD
      const twd = subtotal / state.rateFT;
      elOut.value = nfTWD.format(twd);
      elRes.textContent = `TWD ${twd.toFixed(2)}`;
    }else{
      // 台幣 -> 外幣：外幣 = 台幣 * rateFT
      const foreign = subtotal * state.rateFT;
      elOut.value = formatInt(foreign);
      elRes.textContent = `${state.ccy} ${formatInt(foreign)}`;
    }
  }

  function setUI(){
    labelIn.textContent =
      (state.direction==='FOREIGN_TO_TWD')
      ? `輸入外幣（${state.ccy}）或運算式`
      : '輸入台幣（TWD）或運算式';
    renderRate();
  }

  async function updateRate(force=false){
    const item=getItem(state.ccy);
    const now=Date.now();
    const active=item.active||'online';
    const stale=!item.ts||(now-item.ts>ONE_DAY);

    if(active==='manual' && typeof item.manualRateFT==='number'){
      state.rateFT=item.manualRateFT; renderRate(); render(); return;
    }
    if(!force && !stale && typeof item.onlineRateFT==='number'){
      state.rateFT=item.onlineRateFT; renderRate(); render(); return;
    }
    try{
      const {rateFT, ts}=await fetchRateFT(state.ccy);
      state.rateFT=rateFT;
      setItem(state.ccy, { ...item, onlineRateFT:rateFT, ts: ts||now, active:'online' });
    }catch{
      const fallback =
        (active==='manual' && typeof item.manualRateFT==='number') ? item.manualRateFT
        : (typeof item.onlineRateFT==='number') ? item.onlineRateFT
        : DEFAULT_RATES_FT[state.ccy];
      state.rateFT=fallback;
    }
    renderRate(); render();
  }

  // ============= 事件綁定 =============
  // 幣別切換（下拉）
  elCcy.addEventListener('change', async () => {
    state.ccy = elCcy.value;
    await updateRate(true);
    setUI(); render();
  });

  // 方向互換
  elSwap.addEventListener('click',()=>{
    state.direction = (state.direction==='FOREIGN_TO_TWD') ? 'TWD_TO_FOREIGN' : 'FOREIGN_TO_TWD';
    setUI(); render(); elIn.focus();
  });

  // 清除
  elClr.addEventListener('click',()=>{
    elIn.value=''; elOut.value=''; sumBox.innerHTML='合計：<b>–</b>';
    elRes.textContent=(state.direction==='FOREIGN_TO_TWD')?'TWD 0':`${state.ccy} 0`;
    elIn.focus();
  });

  // 更新匯率（線上）
  elRefresh.addEventListener('click',()=> updateRate(true));

  // 手動匯率（外幣/台幣）
  applyRate.addEventListener('click', ()=>{
    const s=(rateInput.value||'').trim();
    const n=Number(s.replace(/[^\d.\-]/g,''));
    if(!n || n<=0){ alert('請輸入有效匯率（> 0），表示「1 TWD 可換多少外幣」'); return; }
    const item=getItem(state.ccy);
    setItem(state.ccy, { ...item, manualRateFT:n, active:'manual' });
    state.rateFT=n; renderRate(); render();
  });

  // 恢復線上
  restoreOnline.addEventListener('click', ()=>{
    const item=getItem(state.ccy);
    setItem(state.ccy, { ...item, active:'online' });
    rateInput.value='';
    updateRate(true);
  });

  // 輸入即時計算
  elIn.addEventListener('input', render);

  // 初始化
  (async function init(){
    // 預設幣別
    elCcy.value = state.ccy;
    const item=getItem(state.ccy);
    state.rateFT =
      (item.active==='manual' && typeof item.manualRateFT==='number') ? item.manualRateFT
      : (typeof item.onlineRateFT==='number') ? item.onlineRateFT
      : DEFAULT_RATES_FT[state.ccy];
    setUI(); renderRate(); render();
    await updateRate(true);
  })();
</script>
</body>
</html>
