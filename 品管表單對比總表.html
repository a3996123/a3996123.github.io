<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Excel QC Comparator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    /* ã€èªªæ˜ã€‘æ‚¨çš„ CSS æ¨£å¼å®Œå…¨ä¿ç•™ï¼Œä¸åšä»»ä½•ä¿®æ”¹ */
    :root {
      --bg-color: #1d1e22;
      --surface-color: #2c2d32;
      --primary-color: #4a8eff;
      --primary-hover: #6ea3ff;
      --text-color: #e0e0e0;
      --border-color: #444;
      --low-bg: rgba(255, 107, 107, 0.2);
      --low-text: #ff8c8c;
      --high-bg: rgba(29, 201, 141, 0.2);
      --high-text: #59f9c7;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); padding: 2em; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
    .container { width: 100%; max-width: 95vw; }
    .controls-panel { background: var(--surface-color); padding: 2em; border-radius: 12px; margin-bottom: 2em; box-shadow: 0 10px 20px rgba(0,0,0,0.2); border: 1px solid var(--border-color); text-align: center; }
    h2 { font-size: 2.5em; font-weight: 600; color: #fff; margin-bottom: 1em; text-shadow: 0 0 10px rgba(74, 142, 255, 0.5); }
    .control-group { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 1.5em; }
    select, button, label { font-size: 1em; font-family: 'Poppins', sans-serif; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); padding: 0.8em 1.2em; transition: all 0.3s ease; }
    select:focus, input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 10px rgba(74, 142, 255, 0.5); }
    button { background: var(--primary-color); color: white; border: none; cursor: pointer; font-weight: 500; }
    button:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(74, 142, 255, 0.4); }
    #output { background: var(--surface-color); padding: 2em; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); border: 1px solid var(--border-color); }
    table { border-collapse: collapse; width: 100%; font-size: 0.85em; table-layout: fixed; word-break: break-all; }
    th { background: var(--primary-color); color: white; padding: 0.8em 0.5em; font-weight: 600; }
    th:first-child { border-top-left-radius: 8px; }
    th:last-child { border-top-right-radius: 8px; }
    td { border-bottom: 1px solid var(--border-color); padding: 0.7em 0.5em; text-align: center; transition: background-color 0.3s ease; }
    tbody tr:hover { background-color: rgba(255, 255, 255, 0.05); }
    tbody tr:last-child td { border-bottom: none; }
    .low { background-color: var(--low-bg); color: var(--low-text); font-weight: 600; }
    .high { background-color: var(--high-bg); color: var(--high-text); font-weight: 600; }
    /* ã€æ–°å¢ã€‘è®€å–ç‹€æ…‹çš„æ¨£å¼ */
    #loadingStatus { font-weight: 500; color: var(--primary-hover); }
  </style>
</head>
<body>
  
  <div class="container">
    <div class="controls-panel">
        <h2>Excel QC Comparator âœ¨</h2>
        <div class="control-group">
            <label>
              é¸æ“‡åˆ†é ï¼š
              <select id="sheetSelect"><option>è®€å–ä¸­...</option></select>
            </label>
            
            <label>
              é¸æ“‡è£½é€ æ—¥æœŸï¼ˆå¯é¸ï¼‰ï¼š
              <select id="dateSelect"><option value="">å…¨éƒ¨</option></select>
            </label>
            
            <button onclick="compareData()">ğŸš€ åŸ·è¡Œæ¯”å°</button>
            
            <div id="loadingStatus"></div>
        </div>
    </div>
    
    <div id="output"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // ã€èªªæ˜ã€‘é€™è£¡ä¿ç•™äº†æ‚¨æ‰€æœ‰çš„æ ¸å¿ƒæ¯”å°é‚è¼¯è®Šæ•¸
    let workbook, refSheetMap = new Map();

    // ã€ä¿®æ”¹ã€‘é€™è£¡æ˜¯ä¸»è¦è®Šå‹•ï¼šå°‡æ‰‹å‹•é¸æ“‡æª”æ¡ˆï¼Œæ”¹ç‚ºåœ¨ç¶²é è¼‰å…¥æ™‚è‡ªå‹•å¾ä¼ºæœå™¨è®€å–
    window.onload = function() {
        // ã€é‡è¦ã€‘è«‹ç¢ºä¿é€™å€‹è·¯å¾‘å’Œæª”åèˆ‡æ‚¨ä¸Šå‚³åˆ° GitHub çš„ Excel æª”æ¡ˆä¸€è‡´
        const excelFilePath = 'data/æˆå“å“è³ªæª¢é©—è¡¨2025.xlsx'; 
        const loadingStatus = document.getElementById('loadingStatus');
        
        loadingStatus.textContent = 'æ­£åœ¨å¾ä¼ºæœå™¨è®€å– Excel æª”æ¡ˆ...';

        // ä½¿ç”¨ fetch API ç²å–é ç«¯çš„ Excel æª”æ¡ˆ
        fetch(excelFilePath)
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥ Excel æª”æ¡ˆï¼Œè«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚');
                }
                return response.arrayBuffer(); // å°‡å›æ‡‰è½‰æ›æˆ ArrayBuffer
            })
            .then(data => {
                const dataArray = new Uint8Array(data);
                workbook = XLSX.read(dataArray, { type: 'array' });
                
                // ã€èªªæ˜ã€‘ä»¥ä¸‹é€™æ®µè™•ç†ç¸½è¡¨ã€å»ºç«‹ refSheetMap çš„é‚è¼¯å®Œå…¨ä¾†è‡ªæ‚¨çš„åŸå§‹ç¢¼ï¼Œä¿æŒä¸è®Š
                const refSheet = XLSX.utils.sheet_to_json(workbook.Sheets['ç¸½è¡¨'], { header: 1 });
                refSheetMap.clear();
                for (let i = 1; i < refSheet.length; i++) {
                    const row = refSheet[i];
                    if (!row[1]) continue;
                    refSheetMap.set(String(row[1]), row);
                }

                // ã€èªªæ˜ã€‘é€™æ®µå¡«å……åˆ†é ä¸‹æ‹‰é¸å–®çš„é‚è¼¯ä¹Ÿå®Œå…¨ä¾†è‡ªæ‚¨çš„åŸå§‹ç¢¼
                const sheetSelect = document.getElementById('sheetSelect');
                sheetSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
                workbook.SheetNames.forEach(name => {
                    if (name !== 'ç¸½è¡¨') {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        sheetSelect.appendChild(opt);
                    }
                });

                document.getElementById('dateSelect').innerHTML = '<option value="">å…¨éƒ¨</option>';
                document.getElementById('output').innerHTML = '';
                loadingStatus.textContent = 'Excel æª”æ¡ˆè®€å–æˆåŠŸï¼';
            })
            .catch(error => {
                console.error(error);
                loadingStatus.textContent = `éŒ¯èª¤ï¼š${error.message}`;
                loadingStatus.style.color = 'var(--low-text)';
            });
    };

    // ã€èªªæ˜ã€‘é€™å€‹ç›£è½åˆ†é é¸æ“‡ã€ä¸¦å¡«å…¥æ—¥æœŸçš„åŠŸèƒ½ï¼Œå®Œå…¨ä¾†è‡ªæ‚¨çš„åŸå§‹ç¢¼ï¼Œä¿æŒä¸è®Š
    document.getElementById('sheetSelect').addEventListener('change', () => {
      const sheetName = document.getElementById('sheetSelect').value;
      if (!sheetName || !workbook) return;
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
      const dateSet = new Set();
      for (let i = 1; i < sheet.length; i++) {
        const d = sheet[i][2];
        if (d) dateSet.add(d);
      }
      const dateSelect = document.getElementById('dateSelect');
      dateSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
      [...dateSet].forEach(date => {
        const opt = document.createElement('option');
        opt.value = date;
        opt.textContent = date;
        dateSelect.appendChild(opt);
      });
      // è‡ªå‹•è§¸ç™¼ä¸€æ¬¡æ¯”å°ï¼Œé¡¯ç¤ºè©²åˆ†é å…¨éƒ¨è³‡æ–™
      compareData(); 
    });

    // ã€èªªæ˜ã€‘æ‚¨çš„æ ¸å¿ƒæ¯”å°å‡½å¼ compareData()ï¼Œå®Œå…¨ä¾†è‡ªæ‚¨çš„åŸå§‹ç¢¼ï¼Œä¿æŒä¸è®Š
    function compareData() {
      const sheetName = document.getElementById('sheetSelect').value;
      const dateFilter = document.getElementById('dateSelect').value;
      if (!sheetName || !workbook) {
        document.getElementById('output').innerHTML = 'è«‹å…ˆé¸æ“‡ä¸€å€‹åˆ†é ã€‚';
        return;
      }
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
      const body = [];

      for (let i = 1; i < sheet.length; i++) {
        const row = sheet[i];
        if (!row.length || (dateFilter && row[2] !== dateFilter)) continue;
        const item = [...row];
        const code = (item[0] || '').replace(/-M$/, '');
        const refRow = refSheetMap.get(code);
        const colorMark = Array(21).fill('');

        if (refRow) {
          [[5, 4, 5], [8, 6, 7], [10, 9,10], [11,11,12]].forEach(([col, low, high]) => {
            const val = parseFloat(item[col]);
            const min = parseFloat(refRow[low]);
            const max = parseFloat(refRow[high]);
            if (!isNaN(val)) {
              if (!isNaN(min) && val < min) colorMark[col] = 'low';
              else if (!isNaN(max) && val > max) colorMark[col] = 'high';
            }
          });
        }
        body.push({ row: item, mark: colorMark });
      }

      const output = document.getElementById('output');
      output.innerHTML = '';
      const table = document.createElement('table');
      const header = document.createElement('tr');
      const headers = [
        'ç”¢å“ç·¨è™Ÿ','æ¡¶åˆ¥','è£½é€ æ—¥æœŸ','æ©Ÿå°','ç­åˆ¥',
        'MI(2.16kg)', 'MI(5kg)', 'MI(21.6kg)','è€è¡æ“Š kg-cm','è€è¡æ“Š kg-cm/cm^2','ç¡¬åº¦','å¯†åº¦','ç¸®æ°´',
        'ç™½é»','é¡†ç²’','è‰²æ¾¤','Lå€¼','Aå€¼','Bå€¼','ç­‰ç´šå€åˆ†','å‚™è¨»'
      ];
      headers.forEach(title => {
        const th = document.createElement('th');
        th.textContent = title;
        header.appendChild(th);
      });
      table.appendChild(header);

      body.forEach(({ row, mark }) => {
        const tr = document.createElement('tr');
        for (let i = 0; i < 21; i++) {
          const td = document.createElement('td');
          td.textContent = row[i] ?? '';
          if (mark[i]) td.classList.add(mark[i]);
          tr.appendChild(td);
        }
        table.appendChild(tr);
      });
      output.appendChild(table);
    }
  </script>
</body>
</html>