<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>品管資料查詢系統</title>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; }
        .container { max-width: 95%; margin: auto; }
        .controls { background-color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        .controls > * { display: inline-block; }
        select, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #loading { font-weight: bold; color: #007bff; }
        .dataTables_wrapper { width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>品管資料查詢系統</h1>
        
        <div class="controls">
            <div>
                <label for="sheetSelect">選擇分頁: </label>
                <select id="sheetSelect"></select>
            </div>
            <div>
                <label for="monthSelect">選擇月份: </label>
                <select id="monthSelect"><option value="">全部</option></select>
            </div>
            <div>
                <label for="dateSelect">選擇日期: </label>
                <select id="dateSelect"><option value="">全部</option></select>
            </div>
            <div>
                <button onclick="filterByDateRange(3)">近三天</button>
                <button onclick="filterByDateRange(7)">近七天</button>
            </div>
            <div id="loading">正在載入 Excel 資料...</div>
        </div>
        
        <div id="tableContainer"></div>
    </div>

<script>
let workbook;
let sheetData = {}; // 用來快取已解析的分頁資料
let headers = [];

// 【核心】從 GitHub Pages 的相對路徑載入 Excel 檔案
const EXCEL_URL = 'data/成品品質檢驗表2025.xlsx';

$(document).ready(function() {
    fetch(EXCEL_URL)
        .then(res => {
            if (!res.ok) {
                throw new Error("找不到 Excel 檔案，請確認 'data/your_data.xlsx' 已上傳。");
            }
            return res.arrayBuffer();
        })
        .then(data => {
            const dataArray = new Uint8Array(data);
            workbook = XLSX.read(dataArray, { type: 'array' });
            
            const sheetSelect = $('#sheetSelect');
            sheetSelect.empty();
            workbook.SheetNames.forEach(name => {
                sheetSelect.append($('<option>', { value: name, text: name }));
            });
            
            $('#loading').text('資料載入完成！');
            // 預設載入第一個分頁的資料
            loadSheetData(workbook.SheetNames[0]);
        })
        .catch(err => {
            $('#loading').text(err.message).css('color', 'red');
        });

    // 監聽下拉選單變化
    $('#sheetSelect').on('change', function() {
        loadSheetData(this.value);
    });
    $('#monthSelect, #dateSelect').on('change', function() {
        renderTable(filterData());
    });
});

function loadSheetData(sheetName) {
    if (!workbook) return;

    if (!sheetData[sheetName]) {
        const sheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        headers = jsonData.length > 0 ? jsonData[0] : [];
        sheetData[sheetName] = jsonData.slice(1).map(row => {
            let rowObj = {};
            headers.forEach((h, i) => rowObj[h] = row[i]);
            return rowObj;
        });
    }

    populateDateFilters(sheetData[sheetName]);
    renderTable(sheetData[sheetName]); // 初始顯示所有資料
}

function populateDateFilters(data) {
    const monthSelect = $('#monthSelect').empty().append('<option value="">全部</option>');
    const dateSelect = $('#dateSelect').empty().append('<option value="">全部</option>');
    
    // **重要**：假設第三欄是日期欄，請根據您的 Excel 調整
    const dateColumnName = headers[2]; 
    if (!dateColumnName) return;

    const months = new Set();
    const dates = new Set();

    data.forEach(row => {
        const dateStr = row[dateColumnName];
        if (dateStr) {
            const dateObj = dayjs(dateStr);
            if (dateObj.isValid()) {
                months.add(dateObj.format('YYYY-MM'));
                dates.add(dateObj.format('YYYY-MM-DD'));
            }
        }
    });

    [...months].sort().reverse().forEach(m => monthSelect.append($('<option>', { value: m, text: m })));
    [...dates].sort().reverse().forEach(d => dateSelect.append($('<option>', { value: d, text: d })));
}

function filterData() {
    const sheetName = $('#sheetSelect').val();
    let data = sheetData[sheetName] || [];

    const monthFilter = $('#monthSelect').val();
    const dateFilter = $('#dateSelect').val();
    const dateColumnName = headers[2]; // 同上，假設第三欄是日期

    if (!dateColumnName) return data;

    return data.filter(row => {
        const dateStr = row[dateColumnName];
        if (!dateStr) return false;
        
        const dateObj = dayjs(dateStr);
        if (!dateObj.isValid()) return false;

        if (dateFilter) {
            return dateObj.format('YYYY-MM-DD') === dateFilter;
        }
        if (monthFilter) {
            return dateObj.format('YYYY-MM') === monthFilter;
        }
        return true;
    });
}

function filterByDateRange(days) {
    // 清空日月篩選器，避免衝突
    $('#monthSelect').val('');
    $('#dateSelect').val('');

    const sheetName = $('#sheetSelect').val();
    let data = sheetData[sheetName] || [];
    const dateColumnName = headers[2]; // 同上，假設第三欄是日期
    
    if (!dateColumnName) {
        renderTable(data);
        return;
    }
    
    const today = dayjs();
    const startDate = today.subtract(days - 1, 'day');

    const filtered = data.filter(row => {
        const dateStr = row[dateColumnName];
        if (!dateStr) return false;
        const dateObj = dayjs(dateStr);
        return dateObj.isValid() && dateObj.isAfter(startDate.startOf('day')) && dateObj.isBefore(today.endOf('day'));
    });

    renderTable(filtered);
}

function renderTable(data) {
    const tableContainer = $('#tableContainer');
    tableContainer.empty();

    if (data.length === 0) {
        tableContainer.text('沒有符合條件的資料。');
        return;
    }

    const table = $('<table>').attr('id', 'dataTable').addClass('display').css('width', '100%');
    tableContainer.append(table);

    $('#dataTable').DataTable({
        data: data,
        columns: headers.map(h => ({ title: h, data: h })),
        destroy: true, // 銷毀已存在的表格，以便重建
        scrollX: true, // 啟用水平捲動
        language: {
            url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/zh-HANT.json"
        }
    });
}
</script>

</body>
</html>