<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Excel QC Comparator</title>
  
  <style>
    /* ä¾†è‡ª index.html çš„åŸºç¤æ¨£å¼ */
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0; 
        padding: 20px; 
        background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        min-height: 100vh;
        box-sizing: border-box;
    }
    .glass-container {
        background: rgba(255, 255, 255, 0.25); 
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 16px;
        padding: 20px;
    }
    .container { 
        max-width: 800px; 
        margin: auto; 
    }
    
    #authSection {
        margin-bottom: 20px;
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    #loginForm {
        margin-bottom: 0; 
    }
    #welcomeMessage {
        display: flex; 
        justify-content: space-between;
        align-items: center;
        font-size: 1.1em;
        color: #333;
    }
    #welcomeMessage button {
        background-color: #dc3545; 
        width: auto; 
        padding: 8px 15px;
        font-size: 14px;
    }
    #welcomeMessage button:hover {
        background-color: #c82333;
    }

    #homeView h2, #loginView h2, .controls-panel h2 { 
        border-bottom: 1px solid rgba(255, 255, 255, 0.3); 
        padding-bottom: 10px; 
        color: #333;
        font-size: 1.5em; /* èª¿æ•´ h2 å¤§å°ä»¥ç¬¦åˆé é¢ */
    }
    label {
        color: #333;
        font-weight: 500;
    }
    .material-list {
        list-style: none;
        padding: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .material-list li {
        flex-grow: 1;
        flex-basis: 150px;
        min-width: 120px;
    }
    .material-list a {
        display: block; 
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 8px; 
        text-decoration: none; 
        color: #333;
        font-weight: 600;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .material-list a:hover { 
        background: rgba(255, 255, 255, 0.7);
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
    }
    #detailView { display: none; }
    .back-link { display: inline-block; margin-bottom: 15px; text-decoration: none; color: #0056b3; font-weight: bold; }
    form { 
        margin-bottom: 20px; 
        padding: 0;
        border: none;
    }
    input, select {
        margin-bottom: 10px; 
        width: auto; /* æ”¹ç‚º auto ä»¥é©æ‡‰ control-group */
        padding: 12px; 
        box-sizing: border-box;
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: #333;
        font-size: 16px;
    }
    input::placeholder {
        color: #555;
    }
    button { 
        background-color: #007bff; 
        color: white; 
        border: none; 
        cursor: pointer;
        padding: 12px;
        font-size: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    button:hover { 
        background-color: #0056b3; 
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }
    #searchForm button[type="submit"] {
        background-color: #28a745;
    }
    #searchForm button[type="submit"]:hover {
        background-color: #218838;
    }
    button:disabled {
        background-color: #aaa;
        box-shadow: none;
    }
    button:disabled:hover {
        transform: none;
        box-shadow: none;
        background-color: #aaa;
    }
    #searchResults {
        margin-top: -10px;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        display: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        overflow: hidden; 
        font-size: 0.9em; /* ç¨å¾®èª¿æ•´å­—é«”å¤§å° */
        word-break: break-all;
    }
    th, td { 
        border: 1px solid rgba(255, 255, 255, 0.3); 
        padding: 10px; /* ç¨å¾®æ¸›å°‘ padding */
        text-align: center; /* QC è¡¨æ ¼ç½®ä¸­ */
    }
    th { 
        background-color: rgba(255, 255, 255, 0.3);
        color: #333;
    }
    tbody tr:hover { 
        background-color: rgba(255, 255, 255, 0.1); 
    }

    /* --- ä»¥ä¸‹æ˜¯ç‚º QC Comparator å®¢è£½åŒ–çš„æ¨£å¼ --- */

    /* è®“å®¹å™¨æ›´å¯¬ä»¥å®¹ç´è¡¨æ ¼ */
    .container {
        max-width: 95vw;
    }
    
    .controls-panel {
        text-align: center;
    }
    
    /* è¤‡è£½åŸæœ‰çš„ control-group ä½ˆå±€ */
    .control-group { 
        display: flex; 
        flex-wrap: wrap; 
        justify-content: center; 
        align-items: center; 
        gap: 1.5em; 
        margin-top: 20px;
        margin-bottom: 20px;
    }
    
    /* å°‡ä¸»è¦æŒ‰éˆ•è¨­ç‚ºç¶ è‰² (åŒ index.html çš„ "æœå°‹") */
    .control-group button {
        background-color: #28a745;
    }
    .control-group button:hover {
        background-color: #218838;
    }
    
    #loadingStatus { 
        display: inline-block; 
        margin-left: 15px; 
        font-weight: 500; 
        color: #333; 
    }

    /* ç‚ºæ·ºè‰²ä¸»é¡Œèª¿æ•´ .low å’Œ .high çš„é¡è‰² */
    .low { 
        background-color: rgba(255, 107, 107, 0.4); 
        color: #b22222; /* æ·±ç´… */
        font-weight: 600; 
    }
    .high { 
        background-color: rgba(29, 201, 141, 0.4); 
        color: #006400; /* æ·±ç¶  */
        font-weight: 600; 
    }
    
    /* è®“è¡¨é ­é¡è‰²æ›´çªå‡º (ä½¿ç”¨ index.html çš„ä¸»è¦è—è‰²) */
    table th {
       background-color: #007bff;
       color: white;
    }

  </style>
</head>
<body>
  
  <div class="container glass-container">
    <div class="controls-panel">
        <h2>Excel QC Comparator âœ¨</h2>
        <div class="control-group">
            <label>
              é¸æ“‡åˆ†é ï¼š
              <select id="sheetSelect"><option>è®€å–ä¸­...</option></select>
            </label>
            
            <label>
              é¸æ“‡è£½é€ æ—¥æœŸï¼š
              <select id="dateSelect"><option value="">å…¨éƒ¨</option></select>
            </label>
            
            <button onclick="compareData()">ğŸš€ åŸ·è¡Œæ¯”å°</button>
            
            <div id="loadingStatus"></div>
        </div>
    </div>
    
    <div id="output"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // JavaScript é‚è¼¯
    let workbook, refSheetMap = new Map();
    let sheetDataCache = {};
    let headersCache = {};

    window.onload = function() {
        const excelFilePath = 'data/æˆå“å“è³ªæª¢é©—è¡¨2025.xlsx'; 
        const loadingStatus = document.getElementById('loadingStatus');
        
        loadingStatus.textContent = 'æ­£åœ¨è®€å– Excel æª”æ¡ˆ...';

        fetch(excelFilePath)
            .then(response => {
                if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥ Excel æª”æ¡ˆ');
                return response.arrayBuffer();
            })
            .then(data => {
                const dataArray = new Uint8Array(data);
                workbook = XLSX.read(dataArray, { type: 'array' });
                
                const refSheet = XLSX.utils.sheet_to_json(workbook.Sheets['ç¸½è¡¨'], { header: 1 });
                refSheetMap.clear();
                for (let i = 1; i < refSheet.length; i++) {
                    const row = refSheet[i];
                    if (!row[1]) continue;
                    refSheetMap.set(String(row[1]), row);
                }

                const sheetSelect = document.getElementById('sheetSelect');
                sheetSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
                workbook.SheetNames.forEach(name => {
                    if (name !== 'ç¸½è¡¨') {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        sheetSelect.appendChild(opt);
                    }
                });
                
                loadingStatus.textContent = 'Excel è®€å–æˆåŠŸï¼';
            })
            .catch(error => {
                console.error(error);
                loadingStatus.textContent = `éŒ¯èª¤ï¼š${error.message}`;
                loadingStatus.style.color = '#b22222'; /* æ”¹ç‚ºæ·±ç´…è‰²éŒ¯èª¤ */
            });
    };

    document.getElementById('sheetSelect').addEventListener('change', () => {
      const sheetName = document.getElementById('sheetSelect').value;
      if (!sheetName || !workbook) return;

      if (!sheetDataCache[sheetName]) {
          const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
          headersCache[sheetName] = sheet.length > 0 ? sheet[0] : [];
          sheetDataCache[sheetName] = sheet.slice(1);
      }
      
      const currentSheetData = sheetDataCache[sheetName];
      const headers = headersCache[sheetName];
      const dateColumnIndex = 2; 

      const dateSet = new Set();
      for (let i = 0; i < currentSheetData.length; i++) {
        const d = currentSheetData[i][dateColumnIndex];
        if (d) dateSet.add(d);
      }
      
      const dateSelect = document.getElementById('dateSelect');
      dateSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
      [...dateSet].sort().reverse().forEach(date => {
        const opt = document.createElement('option');
        opt.value = date;
        opt.textContent = date;
        dateSelect.appendChild(opt);
      });
      processAndRender(currentSheetData, headers);
    });
    
    document.getElementById('dateSelect').addEventListener('change', () => {
        compareData();
    });

    function compareData() {
      const sheetName = document.getElementById('sheetSelect').value;
      const dateFilter = document.getElementById('dateSelect').value;
      if (!sheetName || !sheetDataCache[sheetName]) return;

      const currentSheetData = sheetDataCache[sheetName];
      const headers = headersCache[sheetName];
      const dateColumnIndex = 2;
      
      const filteredData = currentSheetData.filter(row => {
          if (!row.length) return false;
          return !dateFilter || row[dateColumnIndex] == dateFilter;
      });

      processAndRender(filteredData, headers);
    }
    
    function processAndRender(dataRows, headers) {
        const body = [];
        for (let i = 0; i < dataRows.length; i++) {
            const row = dataRows[i];
            const item = [...row];
            const code = (item[0] || '').replace(/-M$/, '');
            const refRow = refSheetMap.get(code);
            const colorMark = Array(21).fill('');

            if (refRow) {
                // ***** é€™è£¡æ˜¯ä¿®æ”¹å¾Œçš„æ ¸å¿ƒé‚è¼¯ (åŒ…å« 5kg åˆ¤æ–·) *****

                // --- è™•ç†ç‰¹æ®Šè¦å‰‡ [5, 4, 5] (Fæ¬„) ---
                { // ç”¨å¤§æ‹¬è™Ÿå»ºç«‹ä¸€å€‹ç¨ç«‹çš„å€å¡Š
                    let dataColIndex = 5; // é è¨­è¦æ¯”å°çš„è³‡æ–™æ¬„ä½æ˜¯ F æ¬„ (ç´¢å¼• 5)
                    const specMinColIndex = 4; // ç¸½è¡¨çš„ Min æ¬„ä½ (E æ¬„)
                    const specMaxColIndex = 5; // ç¸½è¡¨çš„ Max æ¬„ä½ (F æ¬„)

                    // å–å¾— "ç¸½è¡¨" è¦æ ¼çš„ "åŸå§‹æ–‡å­—" (ç‚ºäº†æª¢æŸ¥ 5kg)
                    // æˆ‘å€‘éœ€è¦å…ˆè½‰æˆå­—ä¸²ï¼Œä»¥é˜²å„²å­˜æ ¼æ˜¯ç´”æ•¸å­—
                    const specMinString = String(refRow[specMinColIndex] || '');
                    const specMaxString = String(refRow[specMaxColIndex] || '');

                    // ä½ çš„æ–°é‚è¼¯ï¼šæª¢æŸ¥ Min æˆ– Max æ¬„ä½æ˜¯å¦åŒ…å« (5kg)
                    if (specMinString.includes('(5kg)') || specMaxString.includes('(5kg)')) {
                        // å¦‚æœæœ‰ï¼Œå°±æ”¹å»æ¯”å°è³‡æ–™çš„ G æ¬„ (ç´¢å¼• 6)
                        dataColIndex = 6;
                    }

                    // å–å¾— "è³‡æ–™" çš„å€¼ (å¯èƒ½æ˜¯ F æ¬„æˆ– G æ¬„)
                    const val = parseFloat(item[dataColIndex]);
                    
                    // å–å¾— "è¦æ ¼" çš„å€¼ (parseFloat æœƒè‡ªå‹•å¿½ç•¥æ–‡å­—ï¼Œåªå–æ•¸å­—)
                    const min = parseFloat(specMinString);
                    const max = parseFloat(specMaxString);

                    // åŸ·è¡Œæ¯”å°ï¼Œä¸¦æ¨™è¨˜ "çœŸæ­£è¢«æ¯”å°" çš„é‚£ä¸€æ¬„ (dataColIndex)
                    if (!isNaN(val)) {
                        if (!isNaN(min) && val < min) {
                            colorMark[dataColIndex] = 'low'; // æ¨™è¨˜ F æ¬„ æˆ– G æ¬„
                        } else if (!isNaN(max) && val > max) {
                            colorMark[dataColIndex] = 'high'; // æ¨™è¨˜ F æ¬„ æˆ– G æ¬„
                        }
                    }
                } // --- ç‰¹æ®Šè¦å‰‡çµæŸ ---


                // --- è™•ç†å‰©ä¸‹çš„"ä¸€èˆ¬"è¦å‰‡ [8, 6, 7], [9, 8, 9] ... ---
                [[8, 6, 7], [9, 8, 9], [10, 10, 11], [11, 12, 13]].forEach(([col, low, high]) => {
                    const val = parseFloat(item[col]);
                    const min = parseFloat(refRow[low]);
                    const max = parseFloat(refRow[high]);
                    if (!isNaN(val)) {
                        if (!isNaN(min) && val < min) colorMark[col] = 'low';
                        else if (!isNaN(max) && val > max) colorMark[col] = 'high';
                    }
                });
            }
            body.push({ row: item, mark: colorMark });
        }
        renderTable(headers, body);
    }

    function renderTable(headers, body) {
        const output = document.getElementById('output');
        output.innerHTML = '';

        if (!headers || headers.length === 0) return;

        if (body.length === 0) {
            output.innerHTML = '<p style="text-align:center; padding: 2em; color: #333;">åœ¨æŒ‡å®šæ¢ä»¶ä¸‹æ²’æœ‰æ‰¾åˆ°è³‡æ–™ã€‚</p>';
            return;
        }

        const table = document.createElement('table');
        const header = document.createElement('tr');
        headers.forEach(title => {
            const th = document.createElement('th');
            th.textContent = title;
            header.appendChild(th);
        });
        table.appendChild(header);

        body.forEach(({ row, mark }) => {
            const tr = document.createElement('tr');
            for (let i = 0; i < headers.length; i++) {
                const td = document.createElement('td');
                td.textContent = row[i] ?? '';
                if (mark[i]) td.classList.add(mark[i]);
                tr.appendChild(td);
            }
            table.appendChild(tr);
        });
        output.appendChild(table);
    }
  </script>
</body>
</html>