<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Excel QC Comparator</title>
  
  <style>
    /* 來自 index.html 的基礎樣式 */
    body { 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0; 
        padding: 20px; 
        background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        min-height: 100vh;
        box-sizing: border-box;
    }
    .glass-container {
        background: rgba(255, 255, 255, 0.25); 
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 16px;
        padding: 20px;
    }
    .container { 
        max-width: 800px; 
        margin: auto; 
    }
    
    #authSection {
        margin-bottom: 20px;
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    #loginForm {
        margin-bottom: 0; 
    }
    #welcomeMessage {
        display: flex; 
        justify-content: space-between;
        align-items: center;
        font-size: 1.1em;
        color: #333;
    }
    #welcomeMessage button {
        background-color: #dc3545; 
        width: auto; 
        padding: 8px 15px;
        font-size: 14px;
    }
    #welcomeMessage button:hover {
        background-color: #c82333;
    }

    #homeView h2, #loginView h2, .controls-panel h2 { 
        border-bottom: 1px solid rgba(255, 255, 255, 0.3); 
        padding-bottom: 10px; 
        color: #333;
        font-size: 1.5em; /* 調整 h2 大小以符合頁面 */
    }
    label {
        color: #333;
        font-weight: 500;
    }
    .material-list {
        list-style: none;
        padding: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .material-list li {
        flex-grow: 1;
        flex-basis: 150px;
        min-width: 120px;
    }
    .material-list a {
        display: block; 
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 8px; 
        text-decoration: none; 
        color: #333;
        font-weight: 600;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .material-list a:hover { 
        background: rgba(255, 255, 255, 0.7);
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
    }
    #detailView { display: none; }
    .back-link { display: inline-block; margin-bottom: 15px; text-decoration: none; color: #0056b3; font-weight: bold; }
    form { 
        margin-bottom: 20px; 
        padding: 0;
        border: none;
    }
    input, select {
        margin-bottom: 10px; 
        width: auto; /* 改為 auto 以適應 control-group */
        padding: 12px; 
        box-sizing: border-box;
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: #333;
        font-size: 16px;
    }
    input::placeholder {
        color: #555;
    }
    button { 
        background-color: #007bff; 
        color: white; 
        border: none; 
        cursor: pointer;
        padding: 12px;
        font-size: 16px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    button:hover { 
        background-color: #0056b3; 
        transform: translateY(-3px);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }
    #searchForm button[type="submit"] {
        background-color: #28a745;
    }
    #searchForm button[type="submit"]:hover {
        background-color: #218838;
    }
    button:disabled {
        background-color: #aaa;
        box-shadow: none;
    }
    button:disabled:hover {
        transform: none;
        box-shadow: none;
        background-color: #aaa;
    }
    #searchResults {
        margin-top: -10px;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        display: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        overflow: hidden; 
        font-size: 0.9em; /* 稍微調整字體大小 */
        word-break: break-all;
    }
    th, td { 
        border: 1px solid rgba(255, 255, 255, 0.3); 
        padding: 10px; /* 稍微減少 padding */
        text-align: center; /* QC 表格置中 */
    }
    th { 
        background-color: rgba(255, 255, 255, 0.3);
        color: #333;
    }
    tbody tr:hover { 
        background-color: rgba(255, 255, 255, 0.1); 
    }

    /* --- 以下是為 QC Comparator 客製化的樣式 --- */

    /* 讓容器更寬以容納表格 */
    .container {
        max-width: 95vw;
    }
    
    .controls-panel {
        text-align: center;
    }
    
    /* 複製原有的 control-group 佈局 */
    .control-group { 
        display: flex; 
        flex-wrap: wrap; 
        justify-content: center; 
        align-items: center; 
        gap: 1.5em; 
        margin-top: 20px;
        margin-bottom: 20px;
    }
    
    /* 將主要按鈕設為綠色 (同 index.html 的 "搜尋") */
    .control-group button {
        background-color: #28a745;
    }
    .control-group button:hover {
        background-color: #218838;
    }
    
    #loadingStatus { 
        display: inline-block; 
        margin-left: 15px; 
        font-weight: 500; 
        color: #333; 
    }

    /* 為淺色主題調整 .low 和 .high 的顏色 */
    .low { 
        background-color: rgba(255, 107, 107, 0.4); 
        color: #b22222; /* 深紅 */
        font-weight: 600; 
    }
    .high { 
        background-color: rgba(29, 201, 141, 0.4); 
        color: #006400; /* 深綠 */
        font-weight: 600; 
    }
    
    /* 讓表頭顏色更突出 (使用 index.html 的主要藍色) */
    table th {
       background-color: #007bff;
       color: white;
    }

  </style>
</head>
<body>
  
  <div class="container glass-container">
    <div class="controls-panel">
        <h2>Excel QC Comparator ✨</h2>
        <div class="control-group">
            <label>
              選擇分頁：
              <select id="sheetSelect"><option>讀取中...</option></select>
            </label>
            
            <label>
              選擇製造日期：
              <select id="dateSelect"><option value="">全部</option></select>
            </label>
            
            <button onclick="compareData()">🚀 執行比對</button>
            
            <div id="loadingStatus"></div>
        </div>
    </div>
    
    <div id="output"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    // JavaScript 邏輯完全不變
    let workbook, refSheetMap = new Map();
    let sheetDataCache = {};
    let headersCache = {};

    window.onload = function() {
        const excelFilePath = 'data/成品品質檢驗表2025.xlsx'; 
        const loadingStatus = document.getElementById('loadingStatus');
        
        loadingStatus.textContent = '正在讀取 Excel 檔案...';

        fetch(excelFilePath)
            .then(response => {
                if (!response.ok) throw new Error('無法載入 Excel 檔案');
                return response.arrayBuffer();
            })
            .then(data => {
                const dataArray = new Uint8Array(data);
                workbook = XLSX.read(dataArray, { type: 'array' });
                
                const refSheet = XLSX.utils.sheet_to_json(workbook.Sheets['總表'], { header: 1 });
                refSheetMap.clear();
                for (let i = 1; i < refSheet.length; i++) {
                    const row = refSheet[i];
                    if (!row[1]) continue;
                    refSheetMap.set(String(row[1]), row);
                }

                const sheetSelect = document.getElementById('sheetSelect');
                sheetSelect.innerHTML = '<option value="">請選擇</option>';
                workbook.SheetNames.forEach(name => {
                    if (name !== '總表') {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name;
                        sheetSelect.appendChild(opt);
                    }
                });
                
                loadingStatus.textContent = 'Excel 讀取成功！';
            })
            .catch(error => {
                console.error(error);
                loadingStatus.textContent = `錯誤：${error.message}`;
                loadingStatus.style.color = '#b22222'; /* 改為深紅色錯誤 */
            });
    };

    document.getElementById('sheetSelect').addEventListener('change', () => {
      const sheetName = document.getElementById('sheetSelect').value;
      if (!sheetName || !workbook) return;

      if (!sheetDataCache[sheetName]) {
          const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
          headersCache[sheetName] = sheet.length > 0 ? sheet[0] : [];
          sheetDataCache[sheetName] = sheet.slice(1);
      }
      
      const currentSheetData = sheetDataCache[sheetName];
      const headers = headersCache[sheetName];
      const dateColumnIndex = 2; 

      const dateSet = new Set();
      for (let i = 0; i < currentSheetData.length; i++) {
        const d = currentSheetData[i][dateColumnIndex];
        if (d) dateSet.add(d);
      }
      
      const dateSelect = document.getElementById('dateSelect');
      dateSelect.innerHTML = '<option value="">全部</option>';
      [...dateSet].sort().reverse().forEach(date => {
        const opt = document.createElement('option');
        opt.value = date;
        opt.textContent = date;
        dateSelect.appendChild(opt);
      });
      processAndRender(currentSheetData, headers);
    });
    
    document.getElementById('dateSelect').addEventListener('change', () => {
        compareData();
    });

    function compareData() {
      const sheetName = document.getElementById('sheetSelect').value;
      const dateFilter = document.getElementById('dateSelect').value;
      if (!sheetName || !sheetDataCache[sheetName]) return;

      const currentSheetData = sheetDataCache[sheetName];
      const headers = headersCache[sheetName];
      const dateColumnIndex = 2;
      
      const filteredData = currentSheetData.filter(row => {
          if (!row.length) return false;
          return !dateFilter || row[dateColumnIndex] == dateFilter;
      });

      processAndRender(filteredData, headers);
    }
    
    function processAndRender(dataRows, headers) {
        const body = [];
        for (let i = 0; i < dataRows.length; i++) {
            const row = dataRows[i];
            const item = [...row];
            const code = (item[0] || '').replace(/-M$/, '');
            const refRow = refSheetMap.get(code);
            const colorMark = Array(21).fill('');

            if (refRow) {
                // ***** 這裡是修改後的核心邏輯 *****
                [[5, 4, 5], [8, 6, 7], [9, 8, 9], [10, 10, 11], [11, 12, 13]].forEach(([col, low, high]) => {
                    const val = parseFloat(item[col]);
                    const min = parseFloat(refRow[low]);
                    const max = parseFloat(refRow[high]);
                    if (!isNaN(val)) {
                        if (!isNaN(min) && val < min) colorMark[col] = 'low';
                        else if (!isNaN(max) && val > max) colorMark[col] = 'high';
                    }
                });
            }
            body.push({ row: item, mark: colorMark });
        }
        renderTable(headers, body);
    }

    function renderTable(headers, body) {
        const output = document.getElementById('output');
        output.innerHTML = '';

        if (!headers || headers.length === 0) return;

        if (body.length === 0) {
            output.innerHTML = '<p style="text-align:center; padding: 2em; color: #333;">在指定條件下沒有找到資料。</p>';
            return;
        }

        const table = document.createElement('table');
        const header = document.createElement('tr');
        headers.forEach(title => {
            const th = document.createElement('th');
            th.textContent = title;
            header.appendChild(th);
        });
        table.appendChild(header);

        body.forEach(({ row, mark }) => {
            const tr = document.createElement('tr');
            for (let i = 0; i < headers.length; i++) {
                const td = document.createElement('td');
                td.textContent = row[i] ?? '';
                if (mark[i]) td.classList.add(mark[i]);
                tr.appendChild(td);
            }
            table.appendChild(tr);
        });
        output.appendChild(table);
    }
  </script>
</body>
</html>